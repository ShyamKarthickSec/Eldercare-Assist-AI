name: Deploy to Fly.io

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggers

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    
    # Optional: Add environment for manual approval
    # environment: production
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
      
      - name: 🔧 Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: 🚀 Deploy Backend to Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          cd server
          flyctl deploy --remote-only --config ../fly.toml
      
      - name: ✅ Deployment summary
        run: |
          echo "### ✅ Deployment Successful! 🚀" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Fly.io" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🌐 **Application URL**: https://eldercare-assist-ai.fly.dev" >> $GITHUB_STEP_SUMMARY
      
      - name: 💬 Notify on failure
        if: failure()
        run: |
          echo "### ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs for errors." >> $GITHUB_STEP_SUMMARY

